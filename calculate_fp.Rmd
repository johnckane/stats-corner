---
title: " R, MySQL and Armchair Analysis"
output: html_notebook
---

```{r}
install.packages("RMySQL")
library(RMySQL)
help(package = "RMySQL")
```

```{r}
# install.packages("tidyverse")
update.packages()
library(tidyverse)
mydb = dbConnect(MySQL(), user='root', password='cz14F4b12', dbname='armchair_analysis', host='localhost')
dbListTables(mydb)
```

```{r}
dbGetQuery(con = mydb,
           "select * from offense where tdret != 0 limit 10")
```

```{r}
# we don't get points for return yards
dbSendQuery(con = mydb,
           "select 
              player
            , gid
            , game
            , seas
            , year
            , team
            , py
            , ints
            , tdp
            , ry
            , rec 
            , tdrec
            , fuml
            from offense") %>%
           fetch() %>%
           View()

dbClearResult(dbListResults(mydb)[[1]])
```

```{r}
# we don't get points for return yards
offense <- dbGetQuery(con = mydb,
           "select 
              player
            , gid
            , game
            , seas
            , year
            , team
            , 0.04*py + -2*ints + 4*tdp + 0.1*ry + 0.1*recy + 6*tdr + 6*tdrec -2*fuml +6*tdret as fp
            from offense") 
```
```{r}
dbGetQuery(con = mydb,
           "select * from conv limit 10")
```



```{r}
two_point <- dbGetQuery(con = mydb,
                        "select a.*,b.gid from conv as a join play as b on a.pid = b.pid  where conv = 1")
rush_two_point <- two_point %>%
  filter(bc != "")
pass_two_point <- two_point %>%
  filter(psr != "")
two_point %>%
  filter(bc == "", psr == "") # forget this one


head(pass_two_point)

offense2 <-
  offense %>%
  left_join(., 
            pass_two_point %>% group_by(gid,psr) %>% summarise(count = n()), 
            by = c("gid","player" = "psr")) %>% 
  mutate(fp = ifelse(is.na(count) == FALSE, fp + 2*count, fp)) %>%
  select(-count)

offense3 <-
  offense2 %>%
  left_join(.,
            pass_two_point %>% group_by(gid,trg) %>% summarise(count= n()),
            by = c("gid","player" = "trg")) %>%
  mutate(fp = ifelse(is.na(count) == FALSE, fp+2*count, fp)) %>%
  select(-count)

offense4 <-
  offense3 %>%
  left_join(.,
            rush_two_point %>% group_by(gid,bc) %>% summarise(count = n()),
            by = c("gid", "player" = "bc")) %>%
  mutate(fp = ifelse(is.na(count) == FALSE, fp+2*count, fp)) %>%
  select(-count)

```  


## Kicking
```{r}
dbGetQuery(con = mydb,
           "select * from fgxp limit 10")
```

```{r}
kicking <- dbGetQuery(con = mydb,
                      "
                      select
                       a.fkicker as player
                      ,a.gid 
                      ,sum(a.pts) as fp
                      from
                      (select 
                        a1.pid
                      , b1.gid
                      , a1.fkicker
                      , case when a1.fgxp = 'XP' and a1.good = 1 then 1 
                             when a1.fgxp = 'FG' and a1.good = 1 and a1.dist <= 39 then 3
                             when a1.fgxp = 'FG' and a1.good = 1 and a1.dist >= 40 and dist <= 49 then 4
                             when a1.fgxp = 'FG' and a1.good = 1 and a1.dist >= 50 then 5
                             when a1.fgxp = 'FG' and a1.good = 0 then -1
                             else 0
                        end as pts
                        from fgxp as a1
                        join play as b1 on a1.pid = b1.pid) as a
                     group by 1,2
                      ")
```


```{r}
dbGetQuery(con = mydb,
           "select * from defense limit 10")
dbGetQuery(con = mydb,
           "select * from defense where tdd != tdret")
defense <- dbGetQuery(con = mydb,
                      "
                      select
                       a.gid
                      ,a.team
                      ,a.year
                      ,sum(a.pts) as fp
                      from
                      (select
                       a1.gid
                      ,a1.team
                      ,a1.year
                      ,a1.sck + 6*a1.tdret + 2*a1.ints + 2*a1.saf +2*a1.blk +2*a1.frcv +6*a1.tdd as pts
                      from defense as a1) as a
                      group by 1,2,3")
```

```{r}
dbGetQuery(con = mydb,
           "select * from game limit 10")

dbGetQuery(con = mydb,
           "select gid,seas,wk,h,ptsh,v,ptsv from game limit 20")
# need to change this to seas, wk, gid, team, pa
all_points <- dbGetQuery(con = mydb,
                         "select seas, wk, gid, h, ptsv as pa_h, v, ptsh as pa_v
                         from game")
head(all_points)

pa <-
  all_points %>%
  select(seas,wk,gid,h,pa_h) %>%
  rename(team = h, pa = pa_h) %>%
  union(.,all_points %>%
          select(seas,wk,gid,v,pa_v) %>%
          rename(team = v, pa = pa_v)
  ) %>%
  mutate(pts = ifelse(pa == 0, 5,
                      ifelse(pa >=1 & pa <=6, 4,
                             ifelse(pa >= 7 & pa <= 13,3,
                                    ifelse(pa >= 14 & pa <= 17,1,
                                           ifelse(pa >= 28 & pa <= 34, -1,
                                                  ifelse(pa >= 35 & pa <= 45, -3,
                                                         ifelse(pa >= 46, -5, 0))))))))


# now yards against
# I think the way to do it is to look at yards by team, then give this value to their opponent

dbGetQuery()



```

```{r}
coach <- dbGetQuery(con = mydb,
                    "select
                      gid
                    , seas
                    , wk
                    , h as coach
                    , case when (ptsh - ptsv) >= 25 then 3
                           when (ptsh - ptsv) between  20 and  24 then 1
                           when (ptsh - ptsv) between  15 and  19 then 1
                           when (ptsh - ptsv) between -15 and -19 then -1
                           when (ptsh - ptsv) between -20 and -24 then -1
                           when (ptsh - ptsv) <= -25 then -3 
                           else 0 end as pts
                    from game
                    union
                    select
                      gid
                    , seas
                    , wk
                    , v as coach
                    , case when (ptsv - ptsh) >= 25 then 3
                           when (ptsv - ptsh) between  20 and  24 then 1
                           when (ptsv - ptsh) between  15 and  19 then 1
                           when (ptsv - ptsh) between -15 and -19 then -1
                           when (ptsv - ptsh) between -20 and -24 then -1
                           when (ptsv - ptsh) <= -25 then -3 
                           else 0 end as pts
                    from game")
```

```{r}
coach %>%
  group_by(coach) %>%
  summarise(ttl = sum(pts)) %>%
  arrange(ttl) %>%
  ungroup() %>%
  summarise(st = sum(ttl))
```

